[GLOBAL]
config_file = conf/config.ini
test = No
debug = Yes
log_file_path = log/test_log.txt

[LOG]
enabled = Yes
path = logs
client_log = debug-client.log
server_log = debug-server.log
telemetry_log = telemetry.log

# Example of adding new var
# new_var = Really happy

[LENS_FOCUS_CONSTANTS]
# lens focus constants.
# trial_focus_pos = 8355  # units of counts. Focuser maps 0 to 16383 for lens focus position.
# for very near field.
# best focus position:
trial_focus_pos = 8352

###### CLI For Autofocus #######
autofocus_start_position = 5000
autofocus_stop_position = 6000
autofocus_step_count = 10
autofocus_method = sequence_contrast

###### COURSE focus finding parameters#######
top_end_span_percentage = 0.60
bottom_end_span_percentage  = 0.80
coarse_focus_step_count = 10

###### FINE focus finding parameters#######
fine_focus_step_count = 10

lens_focus_homed = False
# exposure_time = 30 * 1000 = 30000 ~ 30 ms
# exposure_time = 1000 * 1000 = 1000000 ~ 1s or 1000 ms
# exposure_time = 100 * 1000 = 100ms PREFERRED DEFAULT
# NOTE, setting this too low will make problems with capture
exposure_time = 1000000
# pixel value offset in counts. This is a pixel bias. Set this to 100 for default.
pixel_bias = 0

# focus should already be close for this to work. Will use ground-based value.
# env_filename = /home/windell/PycharmProjects/pueo_star_tracker/ASI_linux_mac_SDK_V1.28/lib/x64/libASICamera2.so
env_filename = ~/ASIStudio/lib/libASICamera2.so

#
# Auto gain constants.
#
# Controls how often the auto-gain algorithm recalculates in autonomous mode.
# Value 'N' means: calculate gain every Nth image, skipping N-1 images in between.
# Set to 0 or a very high number to disable periodic auto-gain updates.
autogain_update_interval = 0

# Number of histogram bins used for statistical analysis in auto-gain calculations.
# Higher values provide finer granularity for analyzing image intensity distribution
# but increase computational load. Lower values are faster but less precise.
autogain_num_bins = 100

# Number of histogram bins used for statistical analysis in auto-exposure calculations.
# Higher values provide finer granularity for analyzing image intensity distribution
# and detecting saturation, but increase computational load. Lower values are faster
# but may reduce exposure precision and saturation detection accuracy.
autoexposure_num_bins = 100

# Number of test points to evaluate when searching for the optimal gain value.
# The algorithm divides the range between min_gain_setting and max_gain_setting
# into this many intervals, captures test images at each gain value, and
# selects the gain that produces the best image quality.
max_autogain_iterations = 10

# Number of test points to evaluate when searching for the optimal exposure time.
# The algorithm tests this many different exposure times between minimum and
# maximum allowable values, captures images at each setting, and chooses the
# exposure time that yields the best results.
max_autoexposure_iterations = 10

# Upper/lower bound for the gain search space. Defines the maximum/minimum gain value
# that the auto-gain algorithm will test during its optimization process.
max_gain_setting = 570
min_gain_setting = 120

# Exposure time search range for auto-exposure optimization (in microseconds).
# The algorithm will test exposure times between these bounds to find the optimal value.
# microseconds: 200ms, 50ms
max_exposure_setting = 200000
min_exposure_setting = 50000

# 0.85 x 65532 For a 16-bit ADC (well width = 14
# autogain_desired_max_pixel_value = 55702
# autoexposure_desired_max_pixel_value = 55702

# 0.85 x 16383 For a 16-bit ADC (well width = 14
autogain_desired_max_pixel_value = 13925
autoexposure_desired_max_pixel_value = 13925

# lab_best_focus = 2700
# Initial camera settings values:
# lab_best_aperture_position defines position of the aperture where 0 stands for max open position (lowest f value)
lab_best_aperture_position = 0
lab_best_focus = 8353
lab_best_gain = 120
# lab_best_exposure: 100 * 1000
lab_best_exposure = 100000
autofocus_max_deviation = 0.3
; Focus tolerance percentage defines the search range around best focus position
; Recommended value between 1.0 (tight) to 5.0 (wide) depending on system stability
; Default 2.5% provides balance between search range and precision
focus_tolerance_percentage = 2.5

# Used in fit_best_focus
fit_points_init = 100

# Distortion Calibration Params
# Actual Target Camera FOV
lab_fov = 10.79490900481796
# Blast image FOV
# lab_fov = 2.58
lab_distortion_coefficient_1 = -0.1
lab_distortion_coefficient_2 = 0.1

# Used by GUI for +- buttons
delta_focus_steps = 10
delta_aperture = 1
delta_exposure_time = 5
delta_gain = 5

[CAMERA]
asi_gama = 50
asi_exposure = 9000
asi_gain = 100
# Flip: {'Name': 'Flip', 'Description': 'Flip: 0->None 1->Horiz 2->Vert 3->Both', 'MaxValue': 3, 'MinValue': 0, 'DefaultValue': 0, 'IsAutoSupported': False, 'IsWritable': True, 'ControlType': 9}
# asi_flip = 3 --> Vertical and Horizontal flipping (mirroring)
asi_flip = 3
roi_bins = 2
pixel_saturated_value_raw8 = 255
# pixel_saturated_value_raw16 = 65532
# For 14 bit well depth CCD Camera the saturated value is 16383
pixel_saturated_value_raw16 = 16383
stdev_error_value = 9999

camera_id_vendor = 0x03c3
camera_id_product = 0x294a

# Camera Well Depth - 14-bit ADC
pixel_well_depth = 14

# A camera and focuser GPIO Pin number for Power Cycle
# NOTE:
# GPIO1 = pin 0
# GPIO2 = pin 1
# GPIO3 = pin 2
# ...
# Camera GPIO1 ~ pin 0
sbc_dio_camera_pin = 0
# Focuser GPIO2 ~ pin 1
sbc_dio_focuser_pin = 1

# sbc_dio_default (bool), how to power cycle GPIO for Camera and Focuser
# False = LOW, True = High
# Note:  False: cycle LOW → HIGH → LOW.
#         True: cycle HIGH → LOW → HIGH.
sbc_dio_default = False
# Time between cycling ms
sbc_dio_cycle_delay = 1000

# ms
# Camera/Focuser Init Delay After the power cycle
power_cycle_wait = 3000

# Hardware Auto Gain Control Configuration
# ========================================

# Enable/disable automatic gain control for the camera hardware
# When True: Camera will automatically adjust gain to optimize exposure
# When False: Manual gain control will be used with fixed gain settings
# Recommended: True for most scenarios to handle varying lighting conditions
hw_autogain_enabled = True

# Hardware Auto Gain Control - Recalibration Interval
# --------------------------------------------------
# Specifies the number of frames between complete autogain recalibrations
#
# Value interpretation:
#   0: Disable periodic recalibration (continuous adjustment only)
#   1: Recalibrate autogain on every frame (most responsive)
#   N: Recalibrate autogain every N frames (balance performance/accuracy)
#
# Example:
#   hw_autogain_recalibration_interval = 3 → recalibrates every 3rd frame
hw_autogain_recalibration_interval = 2

[SOURCES]
# img_bkg_threshold = 3.1
img_bkg_threshold = 8.0
img_number_sources = 40
# img_min_size = 20
img_min_size = 100
# img_max_size = 600
img_max_size = 200

# source_finder.py
local_sigma_cell_size = 36
sigma_clipped_sigma = 3.0
sigma_clip_sigma = 3.0
leveling_filter_downscale_factor = 4

src_box_size_x = 50
src_box_size_y = 50
src_filter_size_x = 3
src_filter_size_y = 3

src_kernal_size_x = 3
src_kernal_size_y = 3
src_sigma_x = 1
src_dst = 1
src_dilate_mask_iterations = 1

photutils_gaussian_kernal_fwhm = 3.0
photutils_kernal_size = 5.0
dilate_mask_iterations = 1
dilation_radius = 5

min_potential_source_distance = 100

# Source Finder level filter size:
# level_filter = 25
level_filter = 36
# Source Level Filter Type: mean|median
level_filter_type = mean
# Source Ring Background Estimation Type: mean|median
ring_filter_type = mean

[STARTRACKER]
# star_tracker_body_rates.py
star_tracker_body_rates_max_distance = 100

focal_ratio = 22692.68
x_pixel_count = 2072
y_pixel_count = 1411

[ASTROMETRY]
# ast_t3_database = data/default_database.npz
# ast_t3_database = data/fov_3.5_mag9_tyc_v3_database.npz
# ast_t3_database = data/fov_2.5-3.5_hip_v4_database.npz
# ast_t3_database = data/fov_2.5-3.5_hip_v4_cedar_database.npz
# ast_t3_database = data/fov_2.1-4.1_mag8_tyc_v5_cedar_database.npz
# ast_t3_database = data/fov_2.1-4.1_mag9_tyc_v5_cedar_database.npz
# ast_t3_database = data/fov_3.5_mag9_tyc_v5_cedar_database.npz
# ast_t3_database = data/fov_3.1_mag9.5_tyc_v6_cedar_database.npz
# ast_t3_database = data/fov_3.34_mag9.5_tyc_v7_cedar_database.npz
# ast_t3_database = data/fov_3.0_mag10.0_tyc_v8_cedar_database.npz
# fov2.5, mag 10 for BLAST image
# ast_t3_database = data/fov_2.5_mag10.0_tyc_v9_cedar_database.npz
# fov2.58, mag 9 for BLAST image
# ast_t3_database = data/fov_2.58_mag9.0_tyc_v10_cedar_database.npz
# Production DATABASE Aligned/Tuned for CAMERA Specification:
ast_t3_database = data/fov_10.79_mag9.0_tyc_v11_cedar_database.npz

ast_is_array = True
ast_is_trail = False
ast_use_photoutils = False
ast_subtract_global_bkg = False
# ast_fast: bool, True: use estimate global noise, False: estimate_local_sigma
# ast_fast = False
ast_fast = False

ast_number_sources = 40
# Note testing with 8.0 solver 1 solves only one test image, with 6.0/5.0 results are better.
# ast_bkg_threshold = 5.0
ast_bkg_threshold = 4.0
# ast_min_size = 20
ast_min_size = 4
ast_max_size = 600

# astrometry.py
# TODO: 15 min_pattern_checking_stars
min_pattern_checking_stars = 15
# min_pattern_checking_stars = 7
# include_angular_velocity calculate angular velocity?
include_angular_velocity = True

# angular_velocity_timeout defines timeout of angular velocity calculation in seconds
# Note: At best we can calculate 2 solutions in 5 to 7 seconds, having a smaller angular_velocity_timeout will always
#       skip velocity calculation.
# angular_velocity_timeout = 1.1
angular_velocity_timeout = 10


# solve_timeout (float, optional): Timeout in milliseconds after which the tetra3 solver will
#                                  give up on matching patterns. Defaults to None.
# THe solution when found is found very quickly within 0.1s. The timeout 1s is more than enough.
# Might not be enough! Setting back to 5000
solve_timeout = 5000.0

[CEDAR]
host = localhost:50051
# host = zaphod:50051
# Cedar detect sigma:
# 1. Comma-separated string (e.g., "1.1,1.2,1.3,2.0")
# 2. Range format (e.g., "1.1-3.0@0.1" for start-end@step)
sigma = 6.0,5.0,4.0,3.0
# sigma=1.5-6.0@0.1

max_size = 50
# Set to 1 to disabled binning
binning = 1
return_binned = False
use_binned_for_star_candidates = False
detect_hot_pixels = False

# Custom Pixel Count and Spatial Filtering
pixel_count_min = 7
pixel_count_max = 75
spatial_distance_px = 54
gaussian_fwhm = 2.0
cedar_downscale = 3.0

[ASTROMETRY.NET]
scale_units = degwidth
# This is FOV range for actual lab_fov = 10.79490900481796
# Target values:
# lab_fov = 10.79490900481796
# scale_low = lab_fov *0.975  = 10.525036279697511
# scale_high = lab_fov *1.025 = 11.064781729938408
# Old values 10.0 .. 11.5

scale_low = 10.52
scale_high = 11.06
downsample = 2
# Overwrite existing files
overwrite = True
no_plots = True
# -l / --cpulimit <seconds>: give up solving after the specified number of
#           seconds of CPU time
cpulimit = 1

#  -d / --depth <number or range>: number of field objects to look at, or range
#          of numbers; 1 is the brightest star, so "-d 10" or "-d 1-10" mean look
#          at the top ten brightest stars only.
depth = 20

sigma = 6.0
nsigma = 8.0

# --crpix-center: set the WCS reference point to the image center
crpix_center = True

# Generate .corr file (keep as False)
corr = False
# Generate new FITS with solution (keep as False)
new_fits = False
# Create default match file (keep as False)
match = False
# Create default solved file (keep as False)
solved = False


[IMAGES]
# PNG Image Compression (using zlib DEFLATE algorithm with different strategies)
# Compression levels (0-9) control the zlib compression intensity:
# 0 = No compression (STORED mode) - fastest, exact pixel data
# 1 = Fastest compression (zlib level 1) - uses Huffman coding only
# 2-5 = Standard zlib compression (levels 2-5) - LZ77 + Huffman
# 6 = Default balance (zlib level 6) - optimal for most cases
# 7-9 = Maximum compression (zlib levels 7-9) - exhaustive LZ77 search
#
# Higher levels use more CPU-intensive strategies:
# - More aggressive LZ77 string matching (longer searches)
# - More Huffman tree optimizations
# - Possible filters: None, Sub, Up, Average, Paeth (auto-selected)
#
# Typical file size reduction examples for 1920x1080 RGBA:
# 0: ~7.9MB  3: ~3.2MB  6: ~2.8MB  9: ~2.7MB
# Note: Exact results depend on image content complexity
png_compression = 1

# Save Raw Images; bool
save_raw = True

min_count = 10
sigma_error_value = 9999
# return_partial_images = True
return_partial_images = False

# Image SIZE Resize:
# Downscale: Focuses on preserving visual quality by using interpolation or averaging.
# Downsample: Focuses on reducing resolution quickly by selecting or discarding pixels.

# 'downscale' mode uses cv2.INTER_AREA interpolation, which is ideal for reducing image size
#     while preserving sharpness and avoiding aliasing.
# 'downsample' mode simply selects every nth pixel, which is faster but may introduce aliasing.
# 'local_mean' mode uses skimage's downscale_local_mean, which averages pixel values in local
#   neighborhoods to produce a smooth downscaled image.

# resize_mode = local_mean | downscale | downsample
#
# Note:                          ORIGINAL
# image_resize   DEBUG resized: (2822, 4144, 3) -> (806, 1184, 3)

; Use these precise scaling factors to maintain integer widths when downscaling 4144x2822 images
;
; REFERENCE TABLE:
; +-------------------+-----------+------------+
; | Factor (f)        | Width (X) | Height (Y) |
; +-------------------+-----------+------------+
; | 1.0               | 4144*     | 2822*      |
; | 2.0               | 2072      | 1411.0     |
; | 3.003831418       | 1380      | 939.6609   |
; | 4.0               | 1036      | 705.5      |
; | 5.005405405       | 828       | 563.9535   |
; | 6.007722008       | 690       | 469.8304   |
; | 7.0               | 592       | 403.1429   |
; | 8.0               | 518       | 352.75     |
; | 9.008695652       | 460       | 313.2609   |
; | 10.00966184       | 414       | 281.8843   |
; | 11.01052632       | 376       | 256.3077   |
; | 12.01149425       | 345       | 234.9623   |
; | 13.01234568       | 318       | 216.8421   |
; | 14.0              | 296       | 201.5714   |
; | 15.01176471       | 276       | 188.0      |
; | 16.0              | 259       | 176.375    |
; +-------------------+-----------+------------+
; * No scaling - original

# SD image resolution: (images saved to SD Card)
resize_mode = downscale
# Target: 775 x 526 => Factor: 4144/775 = 5.3471
# scale_factor_x = 5.347096
# scale_factor_y = 5.347096

# scale_factor_x = 16.0
# scale_factor_y = 16.0
scale_factor_x = 4.0
scale_factor_y = 4.0

# RAW image resolution (images saved as RAWs to SSD Disk)
raw_resize_mode = downscale
# raw_scale_factor_x = 5.005405405
# raw_scale_factor_y = 5.005405405
raw_scale_factor_x = 1.0
raw_scale_factor_y = 1.0

# Tested with Windell, decision: keep 4.0 downscale for FOI image
foi_resize_mode = downscale
foi_scale_factor_x = 4.0
foi_scale_factor_y = 4.0
# foi_scale_factor_x = 5.005405405
# foi_scale_factor_y = 5.005405405

# Inspection images settings
inspection_images_keep = 100
inspection_quality = 80
inspection_lower_percentile = 1
inspection_upper_percentile = 99
inspection_last_image_symlink_name = last_inspection_image.jpg

[PATHS]
# Paths used in
auto_gain_image_path_tmpl = ./autogain/{timestamp_string}_auto_gain_exposure_images/
focus_image_path_tmpl = ./autogain/{timestamp_string}_coarse_focus_images/
ultrafine_focus_image_path_tmpl = ./autogain/{timestamp_string}_ultrafine_focus_images/
partial_results_path = ./partial_results/
partial_image_name = 0 - Input Image.png
# Path for solutions within logs subfolder
astro_path = logs/astro.json

# NOTE: PATHs must end with /
# Defines path for saving RAWs, note that in SBC1, the ssd_path/ is linked to the mounted SSD1
ssd_path = ssd_path/
# Defines path for saving downscalled images
sd_card_path = sd_card_path/

# Defied path for saving final images
# final_path = ssd_path/final/
final_path = output/

calibration_params_file = calibration_params_best.txt

gui_images_path = images/

# Inspection images path
inspection_path = inspection_images/

# Web path
web_path = web/

[GENERAL]
# flight_mode: str: preflight, flight
#   preflight: normal operation but images not saved (RAW, FINAL, ...)
#   flight: normal operation
flight_mode = preflight
# solver: str: solver1 (ESA)|solver2 (Cedar)|solver3 (astrometry.net);
# defines which solver will be used automatically at startup
solver = solver1
# time_interval: defines image cadence in ms
# 1s = 1*1e6 = 1000000
# 5s = 5000000 (default)
# 10s = 10*1e6 = 10000000
time_interval = 5000000
max_processes = 1
operation_timeout = 60

# current_timeout [s] defines a timeout for angular velocity calculation
# See angular_velocity_timeout
current_timeout = 200.0

# Run autofocus routine on server startup.
# Default: True (enabled)
run_autofocus = False

# Adjust camera gain automatically before/after autofocus.
# Improves focus accuracy in low-light conditions but may increase noise.
# Default: True (enabled)
enable_autogain_with_autofocus = False

# run_autonomous, set to True to enable autonomous mode when starting server (server starts taking images)
run_autonomous = False

# run_telemetry, set to True to enable collecting telemetry data at all times to logs/telemetry.log
run_telemetry = True

# run_chamber, set to True to enable normal camera capture but serve images from test_images folder
# Chamber mode is  used for testing in a dark chamber, to generate heat by normal operation yet getting viable test images for solving
run_chamber = False

# run_test: Run test is a special mode that will perform chamber mode with all files found in test_images
# run_test = True
run_test = False

[DEVICES]
# Serial port device path for the focuser hardware.
focuser_port = /dev/ttyS1

# (Reserved for future use) Serial port for direct communication with
# an external computer system. Currently non-functional.
computer_port = /dev/ttyUSB100

# Serial port device path for the Arduino responsible for telemetry data
# (e.g., temperature sensors, system health monitoring).
# Prefer the stable '/dev/serial/by-id/' path if all units are consistent.
telemetry_port = /dev/ttyUSB0
# telemetry_port = /dev/serial/by-id/usb-1a86_USB_Serial-if00-port0

# Baud rate for communication with the telemetry Arduino.
telemetry_baud_rate = 115200

# Baud rate for communication with the focuser on focuser_port.
baud_rate = 115200

[STAR_COMM_BRIDGE]
# The network interface IP address that the PUEO server's communication bridge will bind to.
# This defines the network address where the server listens for incoming connections from clients and the flight computer.
# Use 0.0.0.0 to listen on all available network interfaces (recommended for most setups).
pueo_server_ip = 0.0.0.0
# pueo_server_ip = 172.20.10.3  # Example: Listen on a specific Wi-Fi interface
# pueo_server_ip = 128.171.31.7 # Example: Listen on a specific wired interface

# The IP address that clients (GUI) and the flight computer will use to connect to this server.
# Typically, this is the server's own actual IP on the network or 127.0.0.1 for local-only access.
# This value may be used for advertising the connection endpoint to clients.
# Used 127.0.0.1 for localhost
server_ip = 127.0.0.1
# server_ip = 192.168.1.92  # Example: The server's static IP on a local network

# The port number on which the PUEO server's bridge listens for incoming connections.
port = 5555

# Maximum time (in seconds) for a client to wait for a response from the PUEO server
# after sending a command before timing out. This client-side timeout should be set
# higher than the server's expected maximum processing time for complex requests
# (e.g., generating a flight solution).
socket_timeout = 15

# Maximum number of times the server will attempt to retry a failed communication
# attempt with a client or flight computer before considering the operation failed.
max_retry = 5

# Delay (in seconds) between consecutive communication retry attempts.
retry_delay = 2

# Maximum number of flight solution API responses to cache or keep in a buffer for exchange.
# A size of 1 ensures the API only provides the most recent solution.
fq_max_size = 1

# Maximum capacity of the internal message queue. This queue buffers incoming JSON API commands
# from clients and outgoing data, ensuring smooth handling of traffic bursts.
msg_max_size = 128

[GUI]
# Controls whether the GUI can receive images and other data through the message queue.
# When True: GUI can pull data and images from the message queue
# When False: Image exchange functionality is disabled, improving performance
enable_gui_data_exchange = False

# Maximum number of recent images to retain in storage. Older images beyond this count
# will be automatically purged to manage disk space and memory usage.
images_keep = 5

# Controls the display order of server log entries in the interface.
# When True: Shows newest log entries at the top (reverse chronological order)
# When False: Shows oldest entries at the top (standard chronological order)
log_reverse = False